<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>OAuth2 PKCE Auth</title>
</head>
<body>
<h2>OAuth2 PKCE Authorization Code Flow</h2>
<button onclick="startAuth()">Login with PKCE</button>

<script>
    // Конфігурація
    const clientId = "public-client";
    const redirectUri = "http://localhost:5173/callback";
    const authServer = "http://localhost:9000/oauth2/authorize"; // Замінити на ваш endpoint
    const scope = "openid";

    // Генерація random string
    function generateRandomString(length) {
        const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
        let result = "";
        for (let i = 0; i < length; i++) {
            const randomIndex = Math.floor(Math.random() * charset.length);
            result += charset.charAt(randomIndex);
        }
        return result;
    }

    // Генерація code challenge
    async function generateCodeChallenge(codeVerifier) {
        const data = new TextEncoder().encode(codeVerifier);
        const digest = await crypto.subtle.digest("SHA-256", data);
        return btoa(String.fromCharCode(...new Uint8Array(digest)))
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=+$/, "");
    }

    async function startAuth() {
        const codeVerifier = generateRandomString(128);
        // const codeChallenge = '47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU';
        const codeChallenge = await generateCodeChallenge(codeVerifier);

        // Зберігаємо code_verifier в localStorage для подальшого використання під час обміну на токен
        localStorage.setItem("pkce_code_verifier", codeVerifier);

        // Складаємо URL для авторизації
        const params = new URLSearchParams({
            response_type: "code",
            client_id: clientId,
            redirect_uri: redirectUri,
            scope: scope,
            code_challenge: codeChallenge,
            code_challenge_method: "S256"
        });

        window.location = `${authServer}?${params.toString()}`;
    }
</script>
</body>
</html>
